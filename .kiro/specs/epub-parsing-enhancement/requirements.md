# EPUB 解析增强需求文档

## 介绍

本规范旨在改进现有的 EPUB 文件解析功能，解决两个核心问题：1) 优化章节内容的解析结构，使其更适合基于章节的阅读进度跟踪；2) 添加章节导航侧边栏，提供更好的章节浏览和跳转体验。

## 术语表

- **EPUB Parser**: EPUB 文件解析器，负责将 EPUB 文件转换为应用可用的数据结构
- **Block**: 应用中的内容块单元，代表一个可渲染的内容片段
- **Chapter Navigation**: 章节导航组件，用于显示和跳转章节
- **Reading Progress**: 阅读进度，基于章节而非单个元素进行跟踪
- **TOC (Table of Contents)**: 目录，EPUB 文件中定义的章节结构

## 需求

### 需求 1: 优化 EPUB 章节解析结构

**用户故事:** 作为用户，我希望 EPUB 内容能够正确解析为章节结构，同时保持基于单个元素的细粒度进度跟踪，以便准确记录阅读位置

#### 验收标准

1. WHEN 解析器遇到 `<body>` 中的 `<title>` 元素 THEN 系统应将其内容提取为章节标题并创建章节标题 block
2. WHEN 解析器处理 `<body>` 中的 `<div>` 内容 THEN 系统应递归解析其中的所有子元素（h3、p、img 等）为独立的 blocks
3. WHEN 创建 block THEN 系统应为每个 HTML 元素（h3、p、img）创建独立的 block，保持元素的原始类型和属性
4. WHEN 解析章节 THEN 系统应创建章节元数据（包含标题、ID、索引），并将该章节的所有内容 blocks 扁平化到主 blocks 数组中
5. WHEN 用户阅读时 THEN 系统应基于单个内容 block（h3、p、img）的索引来跟踪阅读进度，保持现有的细粒度进度跟踪
6. WHEN 解析图片元素 THEN 系统应保留图片的 src 和 alt 属性，并正确处理相对路径转换为 Data URL
7. WHEN 解析段落元素 THEN 系统应保留段落的 style 属性（如 text-indent）以维持原始格式
8. WHEN 解析 h3 标题元素 THEN 系统应创建标题类型的 block，保持标题层级信息
9. WHEN 遇到 meta、link、script 等非内容元素 THEN 系统应跳过这些元素，不创建 block

### 需求 2: 实现章节导航侧边栏

**用户故事:** 作为用户，我希望在阅读页面能够快速查看和跳转到不同章节，以便更方便地浏览小说内容

#### 验收标准

1. WHEN 用户打开阅读页面 THEN 系统应在设置按钮旁边显示章节导航按钮
2. WHEN 用户点击章节导航按钮 THEN 系统应打开章节导航侧边栏
3. WHEN 侧边栏打开 THEN 系统应显示当前书籍的所有章节列表
4. WHEN 用户点击章节项 THEN 系统应跳转到对应章节并关闭侧边栏
5. WHEN 显示章节列表 THEN 系统应高亮显示当前正在阅读的章节
6. WHEN 用户点击侧边栏外部或关闭按钮 THEN 系统应关闭章节导航侧边栏
7. WHEN 章节导航侧边栏打开 THEN 系统应支持滚动查看所有章节
8. WHEN EPUB 文件包含 TOC 信息 THEN 系统应使用 TOC 中的章节标题和顺序

### 需求 3: 章节数据结构增强

**用户故事:** 作为开发者，我希望有清晰的章节数据结构，以便更好地管理和展示章节信息

#### 验收标准

1. WHEN 解析 EPUB 文件 THEN 系统应提取章节元数据（标题、顺序、ID）
2. WHEN 存储章节信息 THEN 系统应将章节元数据（包含 blockStartIndex 和 blockEndIndex）与扁平化的 blocks 数组关联
3. WHEN 加载书籍 THEN 系统应能够快速访问章节列表而无需重新解析整个内容
4. WHEN 章节包含子章节 THEN 系统应保持章节的层级结构
5. WHEN 用户跳转章节 THEN 系统应能够根据章节 ID 快速定位到对应的 blocks

